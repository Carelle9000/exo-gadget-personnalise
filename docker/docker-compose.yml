# -----------------------------------
# docker-compose.yml (ex√©cution des services)
# -----------------------------------
services:
  mysql:
    image: mysql:8.0
    container_name: exo_mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - exo-net
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -uroot -p$MYSQL_ROOT_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 10

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.10.2
    container_name: exo_elasticsearch
    restart: always
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    networks:
      - exo-net

  onlyoffice:
    image: onlyoffice/documentserver
    container_name: exo_onlyoffice
    restart: always
    ports:
      - "${ONLYOFFICE_PORT}:80"
    networks:
      - exo-net

  exo:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: exo_platform
    restart: always
    depends_on:
      mysql:
        condition: service_healthy
      elasticsearch:
        condition: service_started
      onlyoffice:
        condition: service_started
    ports:
      - "${EXO_PORT}:8080"
    environment:
      EXO_PROFILE: community
      EXO_APP_NAME: "eXo Platform Community"
      EXO_DB_TYPE: mysql
      EXO_DB_NAME: ${MYSQL_DATABASE}
      EXO_DB_USER: ${MYSQL_USER}
      EXO_DB_PASSWORD: ${MYSQL_PASSWORD}
      EXO_DB_HOST: mysql
      EXO_ES_HOST: elasticsearch
      EXO_ES_PORT: 9200
      EXO_ONLYOFFICE_SERVER: http://onlyoffice:80
    volumes:
      - exo_data:/srv/exo
      - exo_logs:/var/log/exo
      - ./webapp.war:/opt/exo/webapps/webapp.war
      - ./exo-gadget-perso.jar:/opt/exo/lib/exo-gadget-perso.jar
    networks:
      - exo-net

volumes:
  mysql_data:
  es_data:
  exo_data:
  exo_logs:

networks:
  exo-net:
    driver: bridge
